<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Melissodes Subgenera Key</title>
<link rel="icon" type="image/png" href="favicon.png">

<style>
 @import url('https://fonts.googleapis.com/css2?family=Roboto:ital,wght@0,100..900;1,100..900&display=swap');
*{
    margin: 0;
    padding: 0;
    box-sizing: border-box;
    font-family: "Roboto", sans-serif;
}
body {
      font-family: Georgia, serif;
      margin: 0;
      padding: 0;
      line-height: 1.6;
      color: #222;
      background-color: rgb(251, 251, 250);
    }
.container {
      max-width: 920px;
      margin: 0 auto;
      padding: 0 20px;
    }
.heading {
    margin: 0 auto;
}
.bar-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin: 40px 0 20px;
      margin-bottom: 10px;
      flex-wrap: wrap;
      gap: 10px;
}
.heading header{
      padding: 20px;
      background-color: white;
      border-style: solid;
      border-color: #F3F4F5;
      border-width: 1.5px;
}
header h1 {
      font-size: 1.63rem;
      margin: 0;
      flex: 1 1 auto;
}
nav {
      flex: 0 0 auto;
}
nav ul {
      list-style: none;
      display: flex;
      flex-wrap: wrap;
      gap: 16px;
      margin: 0;
      padding: 0;
}
nav a {
      text-decoration: none;
      color: #000;
      font-size: 0.95rem;
}
.page{
    background-color: white;
    border-style: solid;
    border-color: #F3F4F5;
    border-width: 1.5px;
}

.resetBtn{
  padding: 10px;
  padding-left: 15px;
  padding-right: 15px;
background: #222;
  cursor: pointer;
  color: #fff;
  text-decoration: none;
  border-radius: 6px;
  transition: background 0.2s;
  border: none;
}
.resetBtn:hover {
  background: #444;
}

.page-header { text-align: center; padding: 1.5rem; }
.page-header p { color: #555; font-size: 1.05rem; }
.sex-toggle { display: flex; justify-content: center; gap: 1.2rem; margin: 1rem 0; font-size: 1rem; flex-wrap: wrap; }
.sex-toggle label { cursor: pointer; }
.hidden-feature { display:none !important; }
.key-layout { display: flex; flex-direction: row; gap: 1rem; align-items: flex-start; padding: 20px; justify-content: center;}
.sidebar {
   flex: 0 0 240px;
   border-right: 1.5px solid #F3F4F5;
   background: white;
   padding: 1rem;
}
.feature-btn {
   width: 100%; text-align: left; margin-bottom: .75rem;
   padding: .8rem 1rem; background-color: rgb(251, 251, 250);
    border-style: solid;
    border-color: rgb(238, 238, 237);
    border-width: 1.5px; border-radius: 6px; cursor: pointer; font-size: 1rem;
   transition: background .25s ease; min-height: 44px;
}
.feature-btn:hover { background: #ececec; }
.dropdown { display: none; margin: .4rem 0 .8rem 0; padding-left: .5rem; }
.dropdown .subsection-btn {
   display: block; width: 100%; text-align: left; margin: .3rem 0;
   padding: .6rem .8rem; border: 1.5px solid #ececec; border-radius: 6px;
   background: white; cursor: pointer; font-size: 0.95rem; transition: background .25s ease; min-height: 44px;
}
.dropdown .subsection-btn:hover { background: #eee; }
.dropdown .subsection-btn.active { background: #dbeafe; border-color: #60a5fa; }
.main-panel { flex: 1; padding: 1rem; min-height: auto; background: #fff; display:flex; flex-direction:column; align-items:center; }
.center-message { color: #666; font-size: 1rem; padding: .25rem .5rem; text-align:center; }
.choices { margin-top: .5rem;  display: flex !important; flex-direction: column !important; gap: .5rem; width:100%; max-width:400px; }
.choice {
   background: #f0f7ff;
   border: 1.5px solid #c6dbe6;
   padding: .5rem;
   border-radius: 6px;
   display: flex; align-items: center; gap: .5rem;
   min-height: 40px;
}
.choice input { transform: scale(1.05); }
.species-grid {
   display: grid;
   grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
   gap: 1rem;
   width: 300px;
   background: white;
   border-left: 1.5px solid #F3F4F5;
}
.species-card {
   background: #fff;
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 14px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
   box-shadow: 0 3px 8px rgba(0,0,0,0.1);
   transition: transform 0.2s ease;
   cursor: pointer;
   margin-left: 15px;
}
.species-card:hover { transform: translateY(-3px); }
.species-card h3 { font-size: 1rem; margin-bottom: 6px; }
a, a:visited, a:hover, a:active { text-decoration: none; color: inherit; font-style: normal; }
.species-card p { font-size: 0.85rem; color: #555; }
.species-card h3 { margin: 0; font-size: 1.2rem; }
.hidden { display: none !important; }
.mobile-choices { margin-top: .25rem; margin-bottom: .5rem;}
.mobile-choices .choice { margin: .25rem 0; }
@media (max-width: 768px) {
  .choices { width: 100% !important; max-width: 100% !important; margin-top: .5rem; display: block !important; }
  .choice { width: 100%; white-space: normal; }
  .species-grid { width: 100%; border-left: none; padding-left: 0; padding-right: 0; }
  .main-panel{ display: none; }
  .key-layout { flex-direction: column; }
  .sidebar { width: 100%; border-right: none; border-bottom: 1.5px solid #F3F4F5; }
  .species-grid { display: flex !important; flex-direction: column !important; align-items: center !important; width: 100% !important; box-sizing: border-box; margin-top: 1rem; }
  .species-card { width: 100% !important; max-width: 340px; margin: 0.5rem 0; }
  .choices { max-width: 100%; }
  .bar-header { flex-direction: column; align-items: center; gap: 12px;}
  .bar-header h1 { text-align: center; }
  nav ul { justify-content: center; }
  #centerMessage { text-align: center; margin: 1rem; }
  .sidebar { padding: 0px !important; }
  footer {
    padding: 20px;
  }
}
.choice span { display: inline-block; line-height: 1.2; word-break: break-word; }
footer {
      margin: 40px 0;
      font-size: 0.85rem;
      color: #555;
    }
</style>
</head>

<body>
<div class="container">

  <div class="heading">
    <header class="bar-header">
      <h1>The Melissodes Project</h1>
      <nav>
        <ul>
         <li><a href="index.html">Home</a></li>
            <li><a href="Melissodes.html">Genus</a></li>
            <li><a href="species-index.html">Species Index</a></li>
            <li><a href="gallery-menu.html">Gallery</a></li>
            <li><a href="contact.html">Contact</a></li>
        </ul>
      </nav>
    </header>
  </div>

  <div class="page">
    <header class="page-header">
      <h1>Key to Male Melissodes</h1>
    </header>

    <div style="text-align:center; margin:1rem;">
      <button id="resetSelections" class="resetBtn">Reset All</button>
    </div>

    <main class="key-layout">

      <!-- SIDEBAR -->
      <aside class="sidebar">

        <button class="feature-btn" data-target="clypeus">Clypeus</button>
        <div class="dropdown" id="clypeus">
          <button class="subsection-btn" data-feature="clypeus" data-sub="structure">Structure</button>
          <button class="subsection-btn" data-feature="clypeus" data-sub="sculpture">Sculpture</button>
          <button class="subsection-btn" data-feature="clypeus" data-sub="hair">Hair</button>
        </div>

        <button class="feature-btn" data-target="terga">Metasomal Terga</button>
        <div class="dropdown" id="terga">
          <button class="subsection-btn" data-feature="terga" data-sub="banding">Banding</button>
          <button class="subsection-btn" data-feature="terga" data-sub="color">Color</button>
        </div>

        <button class="feature-btn" data-target="antennae">Antennae</button>
        <div class="dropdown" id="antennae">
          <button class="subsection-btn" data-feature="antennae" data-sub="length">Length</button>
          <button class="subsection-btn" data-feature="antennae" data-sub="proportion">Proportion</button>
          <button class="subsection-btn" data-feature="antennae" data-sub="color">Color</button>
        </div>

        <button class="feature-btn" data-target="sterna">Metasomal Sterna</button>
        <div class="dropdown" id="sterna">
          <button class="subsection-btn" data-feature="sterna" data-sub="margin">Margin</button>
          <button class="subsection-btn" data-feature="sterna" data-sub="flap">Flap</button>
        </div>

      </aside>

      <!-- MAIN PANEL -->
      <section class="main-panel">
        <div id="centerMessage" class="center-message">Select a trait.</div>
        <div id="choices" class="choices"></div>
      </section>

      <!-- SPECIES GRID -->
      <section id="species-grid" class="species-grid">

        <!-- Example species cards — replace/expand as needed -->
        <div class="species-card" data-clypeus-structure="protruding" data-clypeus-hair="black" data-antennae-length="long" data-terga-banding="narrow" data-link="Melissodes-Ablusus.html">
          <h3>Melissodes ablusus</h3>
          <p>Subgenus: Callimelissodes</p>
        </div>

        <div class="species-card" data-clypeus-structure="convex" data-clypeus-hair="red" data-antennae-length="medium" data-sterna-flap="present" data-link="species-example3.html">
          <h3>Melissodes placeholdera</h3>
          <p>Subgenus: Placeholder</p>
        </div>

      </section>

    </main>

    <footer style="text-align:center; margin:40px 0; color:#555; font-size:.85rem;">
      © 2025 The Melissodes Project. All Rights Reserved.
    </footer>

  </div>
</div>

<script>
// ---------------------------
// Track selections per sex
let currentSex = 'male';
const selections = { male: {}, female: {} };
const speciesCards = Array.from(document.querySelectorAll('.species-card'));
const centerMessage = document.getElementById('centerMessage');
const choicesEl = document.getElementById('choices');

// ---------------------------
// Sex toggle behavior
// Track last active subsection per sex (only when visible)
const lastActiveSubsection = { male: null, female: null };

// ---------------------------
// Sex toggle behavior
document.querySelectorAll('input[name="sex"]').forEach(radio => {
  radio.addEventListener('change', () => {
    currentSex = radio.value;
    centerMessage.style.display = 'block';
    choicesEl.innerHTML = '';
    document.querySelectorAll('.mobile-choices').forEach(el => el.remove());

    updateFeatureVisibility();
    filterSpecies();

    // Restore last active subsection only if it was left open
    const last = lastActiveSubsection[currentSex];
    if (last && !last.collapsed) {
      const btn = document.querySelector(`.subsection-btn[data-feature="${last.feature}"][data-sub="${last.sub}"]`);
      if (btn) {
        document.querySelectorAll('.subsection-btn.active').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        showChoicesFor(last.feature, last.sub);
      }
    }
  });
});

// ---------------------------
// Remember last active subsection on click
document.querySelectorAll('.subsection-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    const feature = btn.dataset.feature;
    const sub = btn.dataset.sub;
    const collapsed = btn.classList.contains('active'); // it will toggle after this click

    if (collapsed) {
      // Subsection was active, now will collapse
      lastActiveSubsection[currentSex] = { feature, sub, collapsed: true };
    } else {
      // Subsection is being activated
      lastActiveSubsection[currentSex] = { feature, sub, collapsed: false };
    }
  });
});

// ---------------------------
// Subsection options per sex
const SUBSECTION_OPTIONS = {
  male: {
    'clypeus-structure': ['protruding','flat','convex'],
    'clypeus-sculpture': ['smooth','punctate','rugose'],
    'clypeus-hair': ['black','brown','red'],
    'terga-banding': ['narrow','wide','interrupted'],
    'terga-color': ['white','yellow'],
    'antennae-length': ['short','medium','long'],
    'antennae-proportion': ['<1/3','~1/3','>=0.4'],
    'antennae-color': ['dark','light'],
    'sterna-margin': ['convex','straight','concave'],
    'sterna-flap': ['present','absent']
  },
  female: {
    'clypeus-female-structure': ['carina present', 'carina absent'],
    'clypeus-sculpture': ['smooth','punctate'],
    'clypeus-hair': ['brown','yellowish'],
    'terga-banding': ['wide','interrupted'],
    'terga-color': ['yellow','white'],
    'antennae-length': ['short','medium'],
    'antennae-proportion': ['<1/3','~1/3'],
    'antennae-color': ['dark','light'],
    'sterna-margin': ['straight','concave'],
    'sterna-flap': ['present','absent']
  }
};

// ---------------------------
// Feature dropdown toggle
document.querySelectorAll('.feature-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    const dd = document.getElementById(btn.dataset.target);
    const isOpen = dd.style.display === 'block';

    // Deactivate any active subsection exactly as if clicked
    document.querySelectorAll('.subsection-btn.active').forEach(activeBtn => {
      activeBtn.classList.remove('active');
      choicesEl.innerHTML = '';
      centerMessage.style.display = 'block';
      document.querySelectorAll('.mobile-choices').forEach(el => el.remove());

      // Update lastActiveSubsection when deactivating via feature-btn
      lastActiveSubsection[currentSex] = null;
    });

    // Toggle dropdown visibility
    dd.style.display = isOpen ? 'none' : 'block';
  });
});

// ---------------------------
// Show choices for subsection
function showChoicesFor(feature, sub) {
  const key = `${feature}-${sub}`;
  const opts = SUBSECTION_OPTIONS[currentSex][key] || [];
  centerMessage.style.display = 'none';
  choicesEl.innerHTML = '';
  let targetContainer;
  const isMobile = window.innerWidth <= 768;

  if (isMobile) {
    const btn = document.querySelector(`.subsection-btn[data-feature="${feature}"][data-sub="${sub}"]`);
    let mobileContainer = btn.nextElementSibling;
    if (!mobileContainer || !mobileContainer.classList.contains('mobile-choices')) {
      mobileContainer = document.createElement('div');
      mobileContainer.className = 'mobile-choices';
      mobileContainer.style.paddingLeft = '0.5rem';
      btn.insertAdjacentElement('afterend', mobileContainer);
    }
    mobileContainer.innerHTML = '';
    targetContainer = mobileContainer;
  } else {
    document.querySelectorAll('.mobile-choices').forEach(el => el.remove());
    targetContainer = choicesEl;
  }

  if (!opts.length) {
    targetContainer.innerHTML = '<div class="center-message">No options defined.</div>';
    return;
  }

  opts.forEach(opt => {
    const wrapper = document.createElement('label');
    wrapper.className = 'choice';
    const input = document.createElement('input');
    input.type = 'checkbox';
    input.dataset.feature = feature;
    input.dataset.sub = sub;
    input.dataset.value = opt;
    input.checked = selections[currentSex][key]?.has(opt) || false;
    input.addEventListener('change', checkboxChanged);
    const span = document.createElement('span');
    span.textContent = opt;
    wrapper.appendChild(input);
    wrapper.appendChild(span);
    targetContainer.appendChild(wrapper);
  });
}

// ---------------------------
// Checkbox change handler
function checkboxChanged(e){
  const f = e.target.dataset.feature, s = e.target.dataset.sub, v = e.target.dataset.value;
  const key = `${f}-${s}`;
  if(!selections[currentSex][key]) selections[currentSex][key]=new Set();
  if(e.target.checked) selections[currentSex][key].add(v);
  else { 
    selections[currentSex][key].delete(v); 
    if(selections[currentSex][key].size === 0) delete selections[currentSex][key]; 
  }
  filterSpecies();
}

// ---------------------------
// Subsection button click
document.querySelectorAll('.subsection-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    document.querySelectorAll('.mobile-choices').forEach(el => el.remove());
    if (btn.classList.contains('active')) {
      btn.classList.remove('active');
      choicesEl.innerHTML = '';
      centerMessage.style.display = 'block';
    } else {
      document.querySelectorAll('.subsection-btn.active').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      showChoicesFor(btn.dataset.feature, btn.dataset.sub);
    }
  });
});

// ---------------------------
// Filter species
function filterSpecies() {
  speciesCards.forEach(card => {
    if (card.dataset.sex && card.dataset.sex !== currentSex) {
      card.classList.add('hidden');
      return;
    }
    let visible = true;
    const sel = selections[currentSex];
    for (const [key, setVals] of Object.entries(sel)) {
      const [feature, sub] = key.split('-');
      const datasetKey = feature + sub.charAt(0).toUpperCase() + sub.slice(1); // camelCase
      const attr = card.dataset[datasetKey] || '';
      const cardVals = attr.split(',').map(s => s.trim().toLowerCase());
      const lowerVals = Array.from(setVals).map(v => v.toLowerCase());
      if (!cardVals.some(cv => lowerVals.includes(cv))) {
        visible = false;
        break;
      }
    }
    card.classList.toggle('hidden', !visible);
  });

  // Alphabetize visible species
  const grid = document.getElementById('species-grid');
  Array.from(grid.children)
    .sort((a, b) => a.querySelector('h3').textContent.localeCompare(b.querySelector('h3').textContent))
    .forEach(el => grid.appendChild(el));
}

// ---------------------------
// Clickable species cards
speciesCards.forEach(card => {
  if (card.dataset.link) {
    card.addEventListener('click', () => location.href = card.dataset.link);
    card.setAttribute('role', 'link');
    card.setAttribute('tabindex', '0');
    card.addEventListener('keydown', e => {
      if (e.key === 'Enter' || e.key === ' ') location.href = card.dataset.link;
    });
  }
});

// ---------------------------
// Reset button
document.getElementById('resetSelections').addEventListener('click', () => {
  selections.male = {}; selections.female = {};
  document.querySelectorAll('.choice input').forEach(i => i.checked = false);
  filterSpecies();
});

// ---------------------------
// Feature visibility update
function updateFeatureVisibility() {
  document.querySelectorAll('.feature-btn').forEach(btn => {
    const sex = btn.dataset.sex || 'both';
    const dd = document.getElementById(btn.dataset.target);
    const show = (sex === 'both' || sex === currentSex);
    btn.classList.toggle('hidden-feature', !show);
    if (dd) dd.classList.toggle('hidden-feature', !show);
  });
  speciesCards.forEach(card => {
    if (card.dataset.sex) card.classList.toggle('hidden', card.dataset.sex !== currentSex);
  });
}

// ---------------------------
// Initial render
filterSpecies();
updateFeatureVisibility();

// ---------------------------
// Re-render on breakpoint change
let lastIsMobile = window.innerWidth <= 768;
window.addEventListener('resize', () => {
  const isMobile = window.innerWidth <= 768;
  if (isMobile !== lastIsMobile) {
    lastIsMobile = isMobile;
    const active = document.querySelector('.subsection-btn.active');
    if (active) showChoicesFor(active.dataset.feature, active.dataset.sub);
    else if (isMobile) choicesEl.innerHTML = '';
  }
});

</script>

</body>
</html>
